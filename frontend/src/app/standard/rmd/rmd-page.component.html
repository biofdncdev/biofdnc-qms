<div class="page">
  <aside class="left">
    <div class="sticky">
      <h2>원료제조팀 규정</h2>

      <div class="search">
        <input
          #searchBox
          type="search"
          placeholder="문서 제목/본문 검색"
          [ngModel]="query()"
          (ngModelChange)="query.set($event)"
          (keydown.enter)="runSearch()"
          (keydown)="onSearchKeydown($event)"
          (keyup.escape)="clearSearch()"
          [disabled]="!indexReady()"
          [class.disabled]="!indexReady()"
        />
        <button class="clear" *ngIf="query()" (click)="clearSearch()">×</button>
        <div class="loader" *ngIf="!indexReady()"></div>
        <div class="search-nav" *ngIf="indexReady() && term() && matchTotal()>0">
          <span>{{ matchIndex()+1 }} / {{ matchTotal() }}</span>
          <button class="nav" (click)="navigate('prev')">▲</button>
          <button class="nav" (click)="navigate('next')">▼</button>
        </div>
      </div>
      <div class="hint" *ngIf="!indexReady()">규정 본문 색인 중입니다… 잠시만 기다려 주세요.</div>
    </div>

    <ng-container *ngIf="searching(); else cats">
      <div *ngIf="results().length===0" class="muted">검색 결과가 없습니다.</div>
      <button
        class="item"
        *ngFor="let it of results()"
        (click)="openResult(it)"
        [class.selected]="selected()?.id === it.id">
        {{ it.id }}. {{ it.title }}
      </button>
    </ng-container>

    <ng-template #cats>
      <ng-container *ngFor="let cat of filtered()">
        <hr />
        <h4 class="cat">{{ cat.category }}</h4>
        <button
          class="item"
          *ngFor="let it of cat.items"
          (click)="select(it)"
          [class.selected]="selected()?.id === it.id">
          {{ it.id }}. {{ it.title }}
        </button>
      </ng-container>
      <p *ngIf="!filtered().length" class="muted">검색 결과가 없습니다.</p>
    </ng-template>
  </aside>

  <main class="right" #rightPane>
    <div class="toolbar">
      <h2 *ngIf="selected(); else choose"> {{ selected()?.title }} </h2>
      <div class="spacer"></div>
      <!-- Toolbar: Add Link dropdown -->
      <div class="toolbar-dropdown">
        <button class="secondary center" (click)="$event.stopPropagation(); toggleMenu('add')">기록 연결</button>
        <div class="menu" *ngIf="addMenuOpen()" (click)="$event.stopPropagation()">
          <input #addSearchInput type="text" placeholder="기록 검색" [ngModel]="recQuery()" (ngModelChange)="setRecQuery($event)" (keydown)="onRecKeydown($event)" />
          <div class="list">
            <button class="item" *ngFor="let r of recResults(); let i = index" [class.active]="i===recIndex()" (click)="chooseLink(r); addMenuOpen.set(false)"><span class="id">{{ r.id }}</span><span class="title">{{ r.title }}</span></button>
          </div>
        </div>
      </div>
      <!-- Toolbar: Linked list dropdown -->
      <div class="toolbar-dropdown">
        <button class="secondary center" (click)="$event.stopPropagation(); toggleMenu('links')">연결된 기록</button>
        <div class="menu" *ngIf="linksMenuOpen()" (click)="$event.stopPropagation()">
          <div class="list">
            <div class="item link-row" *ngFor="let l of linkedRecords()" (mouseenter)="$event.stopPropagation()">
              <button class="text" (click)="openLinkedRecord(l.id); linksMenuOpen.set(false)">{{ l.id }} · {{ l.title }}</button>
              <button class="remove" title="삭제" (click)="removeLink(l); $event.stopPropagation()">×</button>
            </div>
            <div class="muted" *ngIf="!linkedRecords().length">없음</div>
          </div>
        </div>
      </div>
      <button class="primary" (click)="print()" [disabled]="!selected()">출력</button>
    </div>
    <div class="hint right" *ngIf="highlightPending()">하이라이트 준비 중…</div>

    <ng-template #choose><h3>규정을 선택해주세요.</h3></ng-template>

    <section class="content" #contentPane [class.loading]="loading()">
      <div *ngIf="loading()" class="loading">로딩 중...</div>
      <iframe *ngIf="docUrl(); else empty" [src]="docUrl()"></iframe>
      <ng-template #empty></ng-template>

      <!-- Removed: Linked Records bottom panel and picker modal per request -->
    </section>
  </main>
</div>
