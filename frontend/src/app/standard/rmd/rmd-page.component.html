<div class="page">
  <aside class="left">
    <div class="sticky">
      <h2>원료제조팀 규정</h2>

      <div class="search">
        <input
          #searchBox
          type="search"
          placeholder="문서 제목/본문 검색"
          [ngModel]="query()"
          (ngModelChange)="query.set($event)"
          (keydown.enter)="runSearch()"
          (keyup.escape)="clearSearch()"
          [disabled]="!indexReady()"
          [class.disabled]="!indexReady()"
        />
        <button class="clear" *ngIf="query()" (click)="clearSearch()">×</button>
        <div class="loader" *ngIf="!indexReady()"></div>
        <div class="search-nav" *ngIf="indexReady() && term() && matchTotal()>0">
          <span>{{ matchIndex()+1 }} / {{ matchTotal() }}</span>
          <button class="nav" (click)="navigate('prev')">▲</button>
          <button class="nav" (click)="navigate('next')">▼</button>
        </div>
      </div>
      <div class="hint" *ngIf="!indexReady()">규정 본문 색인 중입니다… 잠시만 기다려 주세요.</div>
    </div>

    <ng-container *ngIf="searching(); else cats">
      <div *ngIf="results().length===0" class="muted">검색 결과가 없습니다.</div>
      <button
        class="item"
        *ngFor="let it of results()"
        (click)="openResult(it)"
        [class.selected]="selected()?.id === it.id">
        {{ it.id }}. {{ it.title }}
      </button>
    </ng-container>

    <ng-template #cats>
      <ng-container *ngFor="let cat of filtered()">
        <hr />
        <h4 class="cat">{{ cat.category }}</h4>
        <button
          class="item"
          *ngFor="let it of cat.items"
          (click)="select(it)"
          [class.selected]="selected()?.id === it.id">
          {{ it.id }}. {{ it.title }}
        </button>
      </ng-container>
      <p *ngIf="!filtered().length" class="muted">검색 결과가 없습니다.</p>
    </ng-template>
  </aside>

  <main class="right" #rightPane>
    <div class="toolbar">
      <h2 *ngIf="selected(); else choose"> {{ selected()?.title }} </h2>
      <div class="spacer"></div>
      <button class="primary" (click)="print()" [disabled]="!selected()">출력</button>
    </div>
    <div class="hint right" *ngIf="highlightPending()">하이라이트 준비 중…</div>

    <ng-template #choose><h3>규정을 선택해주세요.</h3></ng-template>

    <section class="content" [class.loading]="loading()">
      <div *ngIf="loading()" class="loading">로딩 중...</div>
      <iframe *ngIf="docUrl(); else empty" [src]="docUrl()" style="width:100%;height:70vh;border:0;"></iframe>
      <ng-template #empty></ng-template>

      <!-- Linked Records bottom panel (inside scroll area) -->
      <section class="linked-records" [class.expanded]="linkedExpanded()">
        <div class="col left">
          <button class="link-btn" (click)="openRecordPicker()">기록 연결</button>
        </div>
        <div class="col right">
          <div class="chips" [class.collapsed]="!linkedExpanded()">
            <span class="chip" *ngFor="let l of linkedRecords()">{{ l.id }} · {{ l.title }}
              <button class="remove" (click)="removeLink(l)">×</button>
            </span>
            <span class="chip empty" *ngIf="!linkedRecords().length">없음</span>
          </div>
        </div>
        <div class="col more-col">
          <button class="more" *ngIf="linkedRecords().length>0" (click)="toggleExpand()">{{ linkedExpanded() ? '접기' : ('펼치기 (' + linkedRecords().length + '개)') }}</button>
        </div>
      </section>

      <!-- Picker Modal -->
      <div class="rec-picker" *ngIf="recPickerOpen()">
        <div class="backdrop" (click)="closeRecordPicker()"></div>
        <div class="modal" role="dialog" aria-label="기록 연결">
          <header>
            <strong>기록 검색</strong>
            <button class="close" (click)="closeRecordPicker()">×</button>
          </header>
          <div class="body">
            <input id="rec-picker-input" type="text" [ngModel]="recQuery()" (ngModelChange)="recQuery.set($event)" (keydown)="onRecKeydown($event)" placeholder="기록 ID/제목 검색" spellcheck="false" />
            <div class="picker-list">
              <div class="picker-item" *ngFor="let r of recResults(); let i = index" [class.active]="i===recIndex()" (click)="chooseLink(r); closeRecordPicker()">{{ r.id }} · {{ r.title }}</div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>
