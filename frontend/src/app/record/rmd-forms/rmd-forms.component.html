<div class="page">
  <!-- Left Sidebar - Filters -->
  <aside class="left" style="flex:0 0 280px; max-width:280px;">
    <div class="sticky">
      <div class="page-head" style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
        <h2>Record <span class="sub">기록관리</span></h2>
        <button class="action primary" (click)="openCreateModal()">기록 추가</button>
      </div>
      <div class="search">
        <input type="search" placeholder="키워드로 검색" [ngModel]="filterService.query()" (ngModelChange)="filterService.query.set($event)">
        <button class="clear" *ngIf="filterService.query()" (click)="filterService.query.set('')">×</button>
      </div>
      <div class="filters">
        <label class="f-title">담당부서로 검색</label>
        <select [ngModel]="filterService.dept()" (ngModelChange)="filterService.dept.set($event); filterService.onFiltersChanged()">
          <option value="">전체</option>
          <option *ngFor="let d of filterService.departments" [value]="d">{{ d }}</option>
        </select>
        <label class="f-title">담당자로 검색</label>
        <input type="text" [ngModel]="filterService.ownerFilter()" (ngModelChange)="filterService.ownerFilter.set($event); filterService.onFiltersChanged()" placeholder="이름/이메일">
        <label class="f-title">기록방법으로 검색</label>
        <div class="btn-group">
          <button class="seg" [class.on]="filterService.method()===''" (click)="filterService.setMethod('')">전체</button>
          <button class="seg" *ngFor="let m of filterService.methods" [class.on]="filterService.method()===m" (click)="filterService.setMethod(m)">{{ m }}</button>
        </div>
        <label class="f-title">기록주기로 검색</label>
        <div class="btn-group">
          <button class="seg" [class.on]="filterService.period()===''" (click)="filterService.setPeriod('')">전체</button>
          <button class="seg" *ngFor="let p of filterService.periods" [class.on]="filterService.period()===p" (click)="filterService.setPeriod(p)">{{ p }}</button>
        </div>
        <label class="inline"><input type="checkbox" [ngModel]="filterService.overdueOnly()" (ngModelChange)="filterService.overdueOnly.set($event); filterService.onFiltersChanged()"> 기록주기가 지난 것만</label>
        <!-- 규정 카테고리 드롭다운 -->
        <label class="f-title">규정 카테고리로 검색</label>
        <select [ngModel]="filterService.standardCategory()" (ngModelChange)="filterService.setStdCat($event)">
          <option value="">전체</option>
          <option *ngFor="let c of categoriesNoISO" [value]="c">{{ c }}</option>
        </select>

        <label class="f-title" style="margin-top:8px;">인증 체계로 검색</label>
        <select [ngModel]="filterService.cert()" (ngModelChange)="filterService.setCert($event)">
          <option value="">전체</option>
          <option value="ISO9001">ISO9001</option>
          <option value="ISO22716">ISO22716</option>
          <option value="ISO14001">ISO14001</option>
          <option value="HALAL">HALAL</option>
        </select>
        <label class="f-title" style="margin-top:8px;">연결된 Audit으로 검색</label>
        <select [ngModel]="filterService.auditCompany()" (ngModelChange)="filterService.auditCompany.set($event); filterService.onFiltersChanged()">
          <option value="">전체</option>
          <option *ngFor="let c of auditCompanies" [value]="c">{{ c }}</option>
        </select>
      </div>
    </div>
  </aside>

  <!-- Center Pane - Results List -->
  <section class="center" #centerPane>
    <section class="results">
      <div class="record-item" *ngFor="let r of filterService.filteredFlat()" (click)="open(r)" [class.selected]="selected()?.id===r.id">
        <div class="record-head">
          <span class="record-id">{{ r.id }}</span>
          <span class="record-title">{{ r.title }}</span>
        </div>
        <div class="meta">
          <span class="chip">{{ r.department || '원료제조팀' }}</span>
          <span class="chip" *ngIf="r.owner">{{ r.owner }}</span>
          <span class="chip" *ngIf="r.method">{{ r.method }}</span>
          <span class="chip" *ngIf="r.period">{{ r.period }}</span>
          <span class="chip" *ngFor="let c of (r.certs||[])">{{ c }}</span>
          <span class="chip" *ngFor="let comp of (r.companies||[])">{{ comp }}</span>
          <span class="chip" *ngIf="r.standard">규정: {{ r.standard }}</span>
          <span class="chip" *ngIf="r.standardCategory && r.standardCategory !== 'ISO'">{{ r.standardCategory }}</span>
        </div>
      </div>
    </section>
  </section>

  <!-- Right Pane - Details -->
  <main class="right" #rightPane style="display: flex; flex-direction: column;">
    <div class="toolbar" style="flex-shrink: 0;">
      <ng-container *ngIf="selected() as sel; else choose">
        <div class="title-wrap">
          <h3 class="doc-title">{{ sel.title }}</h3>
          <div class="doc-meta">문서번호: {{ sel.id }}</div>
        </div>
      </ng-container>
      <div class="spacer"></div>
    </div>
    <ng-template #choose><h3 style="padding: 16px;">좌측에서 항목을 선택하세요.</h3></ng-template>
    
    <section class="content" style="flex: 1; overflow-y: auto; padding: 16px;">
      <div *ngIf="selected() as sel">
        <!-- Metadata Section -->
        <ng-container *ngTemplateOutlet="metadataSection; context: { sel: sel }"></ng-container>
        
        <!-- Content Based on Selection -->
        <ng-container *ngIf="sel.id==='BF-RMD-PM-IR-07'; else genericInfo">
          <ng-container *ngTemplateOutlet="thRecordSection; context: { sel: sel }"></ng-container>
        </ng-container>
        
        <ng-template #genericInfo>
          <!-- File Upload Section: checkbox controls visibility regardless of file existence -->
          <ng-container *ngIf="sel.features?.uploadFiles === true">
            <ng-container *ngTemplateOutlet="pdfUploadSection; context: { sel: sel }"></ng-container>
          </ng-container>
        </ng-template>
      </div>
    </section>
  </main>
</div>

<!-- Create record modal -->
<div class="modal-overlay" *ngIf="createOpen()" (click)="closeCreateModal()">
  <div class="modal-content" (click)="$event.stopPropagation()" style="max-width:640px;">
    <div class="modal-header">
      <h3>새 기록 생성</h3>
      <button class="close-btn" (click)="closeCreateModal()">×</button>
    </div>
    <div class="modal-body" style="display:grid; grid-template-columns: 1fr 1fr; gap:12px 16px; align-items:end;">
      <div style="grid-column:1 / span 2; display:flex; gap:10px; align-items:center;">
        <div style="flex:1; display:flex; flex-direction:column;">
          <label>규정카테고리 선택</label>
          <select [(ngModel)]="create.categoryId" style="height:36px;">
            <option [ngValue]="''">선택</option>
            <option *ngFor="let c of allCategoriesForCreate" [ngValue]="c.id">{{ c.doc_prefix }} {{ c.name }}</option>
          </select>
        </div>
      </div>
      <div style="grid-column:1 / span 2; display:flex; gap:10px;">
        <div style="flex:1; display:flex; flex-direction:column;">
          <label>기록명</label>
          <input type="text" [(ngModel)]="create.title" style="height:36px;">
        </div>
      </div>
      <div style="grid-column:1 / span 2;">
        <label>문서번호</label>
        <div style="display:flex; gap:8px; align-items:center;">
          <input type="text" style="flex:1; height:36px;" [(ngModel)]="create.docNo">
          <button class="action" (click)="autoNumberCreate()" [disabled]="busyCreate() || !create.categoryId">자동채번</button>
          <span *ngIf="dupCreate()" style="color:#ef4444; font-weight:600;">중복 번호</span>
        </div>
      </div>
      <div style="grid-column:1 / span 2; display:flex; gap:8px; justify-content:flex-end; margin-top:6px;">
        <button class="action primary" (click)="submitCreate()" [disabled]="busyCreate()">{{ busyCreate()? '저장중…' : '추가' }}</button>
        <button class="action" (click)="closeCreateModal()" [disabled]="busyCreate()">닫기</button>
      </div>
    </div>
  </div>
</div>
<!-- Metadata Template -->
<ng-template #metadataSection let-sel="sel">
  <div class="section-row toolbar-line">
    <div class="section-title">기록 정보</div>
    <div style="display:flex; align-items:center; gap:10px;">
      <span class="saved-badge" *ngIf="metadataService.metaJustSaved()">저장됨</span>
      <button class="action" (click)="metadataService.toggleInfo()">{{ metadataService.infoOpen() ? '간략히 보기' : '자세히 보기' }}</button>
      <button class="action" (click)="openEditModal(sel)">수정</button>
      <button class="action" [disabled]="metadataService.isSavingMeta()" (click)="metadataService.saveMeta(sel)">저장</button>
      <button class="action" [disabled]="metadataService.isDeletingMeta()" (click)="deleteRecord(sel)">{{ metadataService.isDeletingMeta() ? '삭제 중...' : '삭제' }}</button>
    </div>
  </div>
  
  <!-- Edit Modal (reuse create modal layout) -->
  <div class="modal-overlay" *ngIf="editOpen()" (click)="closeEditModal()">
    <div class="modal-content" (click)="$event.stopPropagation()" style="max-width:640px;">
      <div class="modal-header">
        <h3>기록 수정</h3>
        <button class="close-btn" (click)="closeEditModal()">×</button>
      </div>
      <div class="modal-body" style="display:grid; grid-template-columns: 1fr 1fr; gap:12px 16px; align-items:end;">
        <div style="grid-column:1 / span 2; display:flex; gap:10px; align-items:center;">
          <div style="flex:1; display:flex; flex-direction:column;">
            <label>규정카테고리 선택</label>
            <select [(ngModel)]="edit.category" style="height:36px;">
              <option [ngValue]="''">선택</option>
              <option *ngFor="let c of allCategoriesForCreate" [ngValue]="c.id">{{ c.doc_prefix }} {{ c.name }}</option>
            </select>
          </div>
        </div>
        <div style="grid-column:1 / span 2; display:flex; gap:10px;">
          <div style="flex:1; display:flex; flex-direction:column;">
            <label>기록명</label>
            <input type="text" [(ngModel)]="edit.title" style="height:36px;">
          </div>
        </div>
        <div style="grid-column:1 / span 2;">
          <label>문서번호</label>
          <div style="display:flex; gap:8px; align-items:center;">
            <input type="text" style="flex:1; height:36px;" [(ngModel)]="edit.docNo">
            <button class="action" (click)="autoNumberEdit()" [disabled]="!edit.category">자동채번</button>
          </div>
        </div>
        <div style="grid-column:1 / span 2; display:flex; gap:8px; justify-content:flex-end; margin-top:6px;">
          <button class="action primary" (click)="applyEdit()">수정</button>
          <button class="action" (click)="closeEditModal()">닫기</button>
        </div>
      </div>
    </div>
  </div>
  <ng-container *ngIf="metadataService.infoOpen(); else infoSummary">
    <div class="detail-form" (ngModelChange)="metadataService.persistMeta(sel)">
      <div>
        <label>담당부서</label>
        <div style="padding:8px; border:1px solid #e5e7eb; border-radius:10px; background:#fff;">
          <div style="display:flex; flex-wrap:wrap; gap:6px; margin-bottom:8px;">
            <span class="chip" *ngFor="let d of (sel.ownerDepartments||[])">
              {{ d }}
              <button class="remove" (click)="removeOwnerDeptChip(sel,d)" title="삭제">×</button>
            </span>
            <span class="muted" *ngIf="!(sel.ownerDepartments||[]).length">선택 없음</span>
          </div>
          <div class="btn-group wrap">
            <label class="inline" *ngFor="let d of filterService.departments" style="margin-right:10px; margin-bottom:6px; display:inline-flex; align-items:center; gap:6px;">
              <input type="checkbox" [checked]="(sel.ownerDepartments||[]).includes(d)" (change)="onToggleOwnerDept(sel, d, $any($event.target).checked)" /> {{ d }}
            </label>
          </div>
        </div>
      </div>
      <div>
        <label>사용부서</label>
        <div style="padding:8px; border:1px solid #e5e7eb; border-radius:10px; background:#fff;">
          <div style="display:flex; flex-wrap:wrap; gap:6px; margin-bottom:8px;">
            <span class="chip" *ngFor="let d of (sel.useDepartments||[])">
              {{ d }}
              <button class="remove" (click)="removeUseDeptChip(sel,d)" title="삭제">×</button>
            </span>
            <span class="muted" *ngIf="!(sel.useDepartments||[]).length">선택 없음</span>
          </div>
          <div class="btn-group wrap" style="max-height:140px; overflow:auto;">
            <label class="inline" *ngFor="let d of filterService.departments" style="margin-right:10px; margin-bottom:6px; display:inline-flex; align-items:center; gap:6px;">
              <input type="checkbox" [checked]="(sel.useDepartments||[]).includes(d)" (change)="onToggleUseDept(sel, d, $any($event.target).checked)" /> {{ d }}
            </label>
          </div>
        </div>
      </div>
      <div>
        <label>담당자</label>
        <div class="typeahead">
          <input #ownerInput type="text" [ngModel]="ownerTyping" (ngModelChange)="onOwnerInputText($event)" (keydown)="onOwnerKeydown($event, sel)" placeholder="이름/이메일" spellcheck="false">
          <div class="suggest" *ngIf="ownerSuggest.length">
            <div class="item" *ngFor="let u of ownerSuggest; let i = index"
              tabindex="-1" role="option"
              [id]="'owner-sg-'+i" [class.active]="i===ownerIndex"
              (click)="chooseOwner(sel,u)"
              (keydown)="onOwnerItemKeydown($event, sel, i)">{{ u }}</div>
          </div>
        </div>
        <div class="chips owners" *ngIf="getOwnerList(sel).length">
          <span class="chip" *ngFor="let n of getOwnerList(sel)">{{ n }}
            <button class="remove" (click)="removeOwnerChip(sel,n)" title="삭제">×</button>
          </span>
        </div>
      </div>
      <div>
        <label>이 기록에 포함될 기능</label>
        <record-features-selector [features]="sel.features || {}" (featuresChange)="onFeaturesChange(sel, $event)"></record-features-selector>
      </div>
      <div>
        <label>기록방법</label>
        <div class="btn-group">
          <button class="seg" *ngFor="let m of filterService.methods" [class.on]="sel.method===m" (click)="sel.method=m; metadataService.persistMeta(sel)">{{ m }}</button>
        </div>
      </div>
      <div>
        <label>기록주기</label>
        <div class="btn-group">
          <button class="seg" *ngFor="let p of filterService.periods" [class.on]="sel.period===p" (click)="sel.period=p; metadataService.persistMeta(sel)">{{ p }}</button>
        </div>
      </div>
      <div>
        <label>인증 체계</label>
        <div class="btn-group wrap">
          <button class="seg" [class.on]="metadataService.isCert(sel,'ISO9001')" (click)="metadataService.toggleCert(sel,'ISO9001')">ISO9001</button>
          <button class="seg" [class.on]="metadataService.isCert(sel,'ISO22716')" (click)="metadataService.toggleCert(sel,'ISO22716')">ISO22716</button>
          <button class="seg" [class.on]="metadataService.isCert(sel,'ISO14001')" (click)="metadataService.toggleCert(sel,'ISO14001')">ISO14001</button>
          <button class="seg" [class.on]="metadataService.isCert(sel,'HALAL')" (click)="metadataService.toggleCert(sel,'HALAL')">HALAL</button>
        </div>
      </div>
      <div>
        <label>규정 카테고리</label>
        <div class="btn-group wrap">
          <button class="seg" *ngFor="let c of categoriesNoISO" [class.on]="sel.standardCategory===c" (click)="sel.standardCategory=c; metadataService.persistMeta(sel)">{{ c }}</button>
        </div>
      </div>
      <div>
        <label>연결된 규정 
          <button class="btn mini" style="margin-left: 10px; font-size: 11px; padding: 4px 8px;" (click)="openStandardSearchModal()">규정 연결</button>
        </label>
        <div class="chips">
          <span class="chip" *ngFor="let s of linkedStandards()" style="position: relative; padding-right: 28px;">
            <span (click)="openStandardTab(s.id)" style="cursor:pointer;">{{ s.id }} · {{ s.title }}</span>
            <button class="close-x" style="position: absolute; right: 4px; top: 50%; transform: translateY(-50%); width: 20px; height: 20px; border: none; background: transparent; cursor: pointer; color: #6b7280; font-weight: bold;" (click)="unlinkStandard(s.id); $event.stopPropagation()">×</button>
          </span>
          <span class="muted" *ngIf="!linkedStandards().length">없음</span>
        </div>
      </div>
      <div>
        <label>연결된 Audit</label>
        <div class="chips">
          <span class="chip" *ngFor="let c of linkedCompanies()">{{ c }}</span>
          <span class="muted" *ngIf="!linkedCompanies().length">없음</span>
        </div>
      </div>
      <div style="grid-column:2;">
        <label>연결된 평가항목</label>
        <ng-container *ngIf="linkedAuditItems().length; else noEval">
          <div class="eval-items" style="padding:10px; border:1px solid #e5e7eb; border-radius:10px; background:#fff; display:flex; flex-direction:column; gap:8px;">
            <div class="eval-item" *ngFor="let a of linkedAuditItems()" (click)="openAuditItemTab(a.number, a.title)">{{ a.number }}. {{ a.title || ('항목 ' + a.number) }}</div>
          </div>
        </ng-container>
        <ng-template #noEval><span class="muted">없음</span></ng-template>
      </div>
    </div>
  </ng-container>
  
  <ng-template #infoSummary>
    <div class="summary-chips">
      <span class="chip">{{ sel.department || '부서 미지정' }}</span>
      <span class="chip" *ngIf="sel.owner">{{ sel.owner }}</span>
      <span class="chip" *ngIf="sel.method">{{ sel.method }}</span>
      <span class="chip" *ngIf="sel.period">{{ sel.period }}</span>
      <span class="chip" *ngIf="sel.standardCategory && sel.standardCategory !== 'ISO'">{{ sel.standardCategory }}</span>
    </div>
  </ng-template>
</ng-template>

<!-- Temperature/Humidity Record Template -->
<ng-template #thRecordSection let-sel="sel">
  <div class="th-toolbar">
    <div class="group">
      <button class="nav pill" title="이전 월" (click)="nudgeDate(-1,'month')"><span class="chev">‹</span><span class="lab">월</span></button>
      <button class="nav pill" title="이전 주" (click)="nudgeDate(-1,'week')"><span class="chev">‹</span><span class="lab">주</span></button>
      <button class="nav pill" title="이전 일" (click)="nudgeDate(-1,'day')"><span class="chev">‹</span><span class="lab">일</span></button>
      <input class="date" type="date" [ngModel]="thService.dateValue()" (ngModelChange)="setDate($event)" />
      <button class="nav pill" title="다음 일" (click)="nudgeDate(1,'day')"><span class="lab">일</span><span class="chev">›</span></button>
      <button class="nav pill" title="다음 주" (click)="nudgeDate(1,'week')"><span class="lab">주</span><span class="chev">›</span></button>
      <button class="nav pill" title="다음 월" (click)="nudgeDate(1,'month')"><span class="lab">월</span><span class="chev">›</span></button>
    </div>
    <div class="group admin">
      <label class="label">기록주기</label>
      <select class="gran" [ngModel]="thService.granularity()" (ngModelChange)="setGranularity($event)" [disabled]="!thService.isAdmin">
        <option value="month">월</option>
        <option value="week">주</option>
        <option value="day">일</option>
      </select>
    </div>
    <div class="group buttons">
      <div class="group tools">
        <button class="secondary" [class.active]="thService.tool()==='pen'" (click)="thService.togglePenMenu()">펜</button>
        <div class="tool-menu" *ngIf="thService.showPenMenu()">
          <div class="row">
            <span>색상</span>
            <button class="swatch" *ngFor="let c of thService.penColors"
              [style.background]="c"
              (click)="thService.setPenColor(c)"
              [style.boxShadow]="thService.penColor()===c ? ('0 0 0 4px ' + c + '55') : 'none'"
              [style.transform]="thService.penColor()===c ? 'scale(1.08)' : 'scale(1)'"
              [attr.aria-label]="c"></button>
          </div>
          <div class="row">
            <span>굵기</span>
            <select [ngModel]="thService.penWidth()" (ngModelChange)="thService.setPenWidth($event)">
              <option *ngFor="let w of thService.penWidths" [value]="w">{{w}}px</option>
            </select>
          </div>
        </div>
        <button class="secondary" [class.active]="thService.tool()==='eraser'" (click)="thService.toggleEraserMenu()">지우개</button>
        <div class="tool-menu" *ngIf="thService.showEraserMenu()">
          <div class="row">
            <span>굵기</span>
            <select [ngModel]="thService.eraserWidth()" (ngModelChange)="thService.setEraserWidth($event)">
              <option *ngFor="let w of thService.eraserWidths" [value]="w">{{w}}px</option>
            </select>
          </div>
        </div>
      </div>
      <button class="secondary" (click)="thService.closeToolMenus(); clearToday()">지우기</button>
      <button class="secondary" (click)="thService.closeToolMenus(); loadRecord()">불러오기</button>
      <button class="primary" (click)="thService.closeToolMenus(); saveRecord()">저장</button>
      <button class="secondary" (click)="thService.closeToolMenus(); printRecord()">인쇄</button>
      <button class="secondary" (click)="toggleFullscreen()">전체화면</button>
    </div>
  </div>
  <div class="pdf-annotator" #container [class.fullscreen]="thService.fullscreen()">
    <button *ngIf="thService.fullscreen()" class="fs-exit" (click)="toggleFullscreen()">닫기</button>
    <canvas #pdfCanvas></canvas>
    <canvas #drawCanvas
      (pointerdown)="onPointerDown($event)" 
      (pointermove)="onPointerMove($event)" 
      (pointerup)="onPointerUp()" 
      (pointercancel)="onPointerUp()"
      (touchstart)="$event.preventDefault()" 
      (touchmove)="$event.preventDefault()" 
      (touchend)="$event.preventDefault()"></canvas>
  </div>
</ng-template>

<!-- PDF Upload Section Template -->
<ng-template #pdfUploadSection let-sel="sel">
  <div class="section-row toolbar-line" style="margin-top: 20px;">
    <div class="section-title">{{ sel.title }} 기록 문서</div>
  </div>
  
  <!-- PDF 드래그앤드롭 업로드 박스 -->
  <div class="pdf-upload-section">
    <div 
      class="dropbox"
      [class.dragover]="pdfService.dragOver()"
      [class.disabled]="pdfService.isUploadingPdf()"
      (dragover)="!pdfService.isUploadingPdf() && pdfService.handleDragOver($event)"
      (dragleave)="!pdfService.isUploadingPdf() && pdfService.handleDragLeave($event)"
      (drop)="!pdfService.isUploadingPdf() && pdfService.handleDrop($event, sel.id)"
      (paste)="pdfService.handleImagePaste($event, sel.title)"
      tabindex="0"
      style="min-height: 100px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px;">
      
      <ng-container *ngIf="!pdfService.pendingPdfFile() && !pdfService.pastedImageUrl()">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="1.5">
          <path d="M12 15V3m0 0l-4 4m4-4l4 4M2 17l.621 2.485A2 2 0 004.561 21h14.878a2 2 0 001.94-1.515L22 17"/>
        </svg>
        <div style="text-align: center;">
          <div style="font-size: 14px; font-weight: 600; color: #475569;">파일을 드래그하여 놓거나 아래 버튼으로 선택</div>
          <div style="font-size: 12px; color: #94a3b8; margin-top: 4px;">지원: PDF, 이미지, 엑셀(xls/xlsx/csv), 워드(doc/docx), 한글(hwp/hwpx) · 영역을 선택한 뒤 Ctrl+V로 이미지 붙여넣기 가능</div>
        </div>
      </ng-container>
      
      <ng-container *ngIf="pdfService.pendingPdfFile()">
        <div class="file-pill" style="background: #dbeafe; padding: 8px 16px;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="#dc2626">
            <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
          </svg>
          <span style="font-weight: 500;">{{ pdfService.pendingPdfFile()!.name }}</span>
          <button type="button" (click)="pdfService.removePendingPdf(); $event.stopPropagation()" style="margin-left: 8px; color: #ef4444; font-weight: bold;">×</button>
        </div>
      </ng-container>

      <!-- Pasted image preview -->
      <ng-container *ngIf="!pdfService.pendingPdfFile() && pdfService.pastedImageUrl()">
        <div style="display:flex; flex-direction:column; align-items:center; gap:8px;">
          <img [src]="pdfService.pastedImageUrl()" alt="pasted" style="max-width:420px; max-height:240px; object-fit:contain; border:1px solid #e5e7eb; border-radius:8px; background:#fff;" />
          <div style="display:flex; gap:8px; align-items:center;">
            <input type="text" [ngModel]="pdfService.pastedFileName()" (ngModelChange)="pdfService.setPastedFileName($event)" style="height:30px; border:1px solid #e5e7eb; border-radius:8px; padding:0 8px;" />
            <button class="action" (click)="pdfService.clearPastedImage()">지우기</button>
            <button class="action primary" [disabled]="pdfService.isSavingPasted()" (click)="pdfService.savePastedImage(sel.id, sel.title)">{{ pdfService.isSavingPasted()? '저장 중...' : '저장' }}</button>
          </div>
        </div>
      </ng-container>
      
      <input #fileInput type="file" accept="application/pdf,image/*,.xlsx,.xls,.csv,.doc,.docx,.hwp,.hwpx" style="display: none;" (change)="onPdfPick($event)">
    </div>
    <div style="display:flex; justify-content:center; margin-top:8px;">
      <button class="action" (click)="fileInput.click()">파일 선택</button>
    </div>
    
    <div *ngIf="pdfService.pdfUploadError()" style="color: #ef4444; font-size: 13px; margin-top: 8px;">{{ pdfService.pdfUploadError() }}</div>
    <div *ngIf="pdfService.pasteError()" style="color: #ef4444; font-size: 13px; margin-top: 4px;">{{ pdfService.pasteError() }}</div>
    
    <button 
      *ngIf="pdfService.pendingPdfFile()" 
      class="action primary" 
      style="margin-top: 12px; min-width: 120px; display: flex; align-items: center; justify-content: center; gap: 8px;"
      [disabled]="pdfService.isUploadingPdf()"
      (click)="pdfService.savePdf(sel.id)">
      <svg *ngIf="pdfService.isUploadingPdf()" class="spinner" width="16" height="16" viewBox="0 0 24 24" fill="none">
        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" opacity="0.25"/>
        <path d="M12 2a10 10 0 0 1 0 20" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      {{ pdfService.isUploadingPdf() ? '업로드 중...' : '저장' }}
    </button>
  </div>
  
  <!-- 저장된 PDF 파일 목록 -->
  <div class="saved-pdfs-section" *ngIf="pdfService.recordPdfs().length > 0" style="margin-top: 24px; margin-bottom: 40px;">
    <div class="section-title" style="margin-bottom: 12px;">저장된 문서</div>
    <div class="pdf-list" style="display: flex; flex-direction: column; gap: 8px;">
      <div 
        *ngFor="let pdf of pdfService.recordPdfs()" 
        class="pdf-item"
        style="display: flex; align-items: center; justify-content: space-between; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; background: #ffffff; transition: all 0.2s;">
        
        <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
          <ng-container *ngIf="pdfService.isImage(pdf); else docIcon">
            <img [src]="pdf.url" alt="thumb" style="width:32px; height:32px; object-fit:cover; border-radius:4px; border:1px solid #e5e7eb;" />
          </ng-container>
          <ng-template #docIcon>
            <svg width="24" height="24" viewBox="0 0 24 24" fill="#64748b">
              <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
            </svg>
          </ng-template>
          
          <div style="flex: 1;">
            <div 
              style="font-weight: 500; color: #1e40af; cursor: pointer; text-decoration: underline;"
              (click)="pdfService.openFile(pdf)">
              {{ pdf.originalName || pdf.name }}
            </div>
            <div style="font-size: 12px; color: #6b7280; margin-top: 2px;">
              {{ pdf.uploadedBy }} · {{ pdf.uploadedAt | date:'yyyy-MM-dd HH:mm' }}
            </div>
          </div>
        </div>
        
        <div style="display: flex; gap: 8px;">
          <button 
            type="button"
            class="action download"
            style="padding: 6px 12px; display: flex; align-items: center; gap: 6px;"
            (click)="pdfService.downloadPdf(pdf)"
            title="다운로드">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            다운로드
          </button>
          
          <button 
            type="button"
            class="action"
            style="width: 30px; height: 30px; padding: 0; display: flex; align-items: center; justify-content: center; border-color: #ef4444; color: #ef4444;"
            (click)="pdfService.removePdf(pdf, sel.id)"
            title="삭제">
            ×
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Image Preview Modal -->
  <div *ngIf="pdfService.showImagePreview()" class="modal-overlay" (click)="pdfService.closeImagePreview()" style="position:fixed; inset:0; background:rgba(17,24,39,.6); z-index:10000;">
    <div (click)="$event.stopPropagation()" [style.left.px]="pdfService.previewPosX()" [style.top.px]="pdfService.previewPosY()" [style.width.px]="pdfService.previewWidth()" [style.height.px]="pdfService.previewHeight()" style="position:fixed; background:#111827; border-radius:12px; box-shadow:0 24px 64px rgba(0,0,0,.6); display:flex; flex-direction:column; overflow:hidden; border:1px solid #0b1220;">
      <!-- Title bar: drag handle + controls -->
      <div (mousedown)="pdfService.startWindowDrag($event)" (dblclick)="pdfService.toggleFullscreen()" style="height:42px; background:#0b1220; color:#ffffff; display:flex; align-items:center; gap:10px; padding:0 10px; cursor:move; user-select:none;">
        <div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-weight:600;">{{ pdfService.previewTitle() }}</div>
        <div style="display:flex; gap:6px; align-items:center;">
          <button class="title-btn" title="최소화" (click)="pdfService.minimizeWindow(); $event.stopPropagation()" style="background:#0b1220; border:1px solid #0b1220; color:#ffffff; width:30px; height:30px; border-radius:6px; display:flex; align-items:center; justify-content:center; font-size:20px; font-weight:bold;">－</button>
          <button class="title-btn" title="최대화" (click)="pdfService.toggleFullscreen(); $event.stopPropagation()" style="background:#0b1220; border:1px solid #0b1220; color:#ffffff; width:30px; height:30px; border-radius:6px; display:flex; align-items:center; justify-content:center; font-size:18px; font-weight:bold;">□</button>
          <button class="title-btn" title="닫기" (click)="pdfService.closeImagePreview(); $event.stopPropagation()" style="background:#0b1220; border:1px solid #0b1220; color:#ffffff; width:30px; height:30px; border-radius:6px; display:flex; align-items:center; justify-content:center; font-size:20px; font-weight:bold;">×</button>
        </div>
      </div>
      <!-- Content -->
      <div #pvWrap (wheel)="pdfService.onPreviewWheel($event)" (mousedown)="pdfService.startPreviewPan($event)" (mousemove)="pdfService.onPreviewPanMove($event)" (mouseup)="pdfService.endPreviewPan()" (mouseleave)="pdfService.endPreviewPan()" style="flex:1; overflow:hidden; display:flex; align-items:center; justify-content:center; cursor:grab; background:#0b1220;">
        <div [style.transform]="'translate(' + pdfService.previewOffsetX() + 'px,' + pdfService.previewOffsetY() + 'px) scale(' + pdfService.previewZoom() + ') rotate(' + pdfService.previewRotate() + 'deg)'" style="transform-origin:center center; transition:transform .05s linear;">
          <img [src]="pdfService.previewImageUrl()" alt="preview" style="object-fit:contain; max-width:none; max-height:none; user-select:none; pointer-events:none; display:block;" />
        </div>
      </div>
      <!-- Bottom bar -->
      <div style="height:44px; background:#0b1220; color:#ffffff; display:flex; align-items:center; justify-content:space-between; padding:0 10px; gap:10px; border-top:1px solid #1f2937;">
        <div style="display:flex; gap:8px; align-items:center;">
          <button class="bar-btn" title="축소" (click)="pdfService.zoomOut()" style="background:#0b1220; border:1px solid #ffffff; color:#ffffff; width:30px; height:30px; border-radius:6px; display:flex; align-items:center; justify-content:center;">－</button>
          <button class="bar-btn" title="확대" (click)="pdfService.zoomIn()" style="background:#0b1220; border:1px solid #ffffff; color:#ffffff; width:30px; height:30px; border-radius:6px; display:flex; align-items:center; justify-content:center;">＋</button>
          <button class="bar-btn" title="회전" (click)="pdfService.rotateCW()" style="background:#0b1220; border:1px solid #ffffff; color:#ffffff; width:30px; height:30px; border-radius:6px; display:flex; align-items:center; justify-content:center;">↻</button>
        </div>
        <div>
          <button class="bar-btn" title="다운로드" (click)="pdfService.downloadCurrentImage()" style="background:#0b1220; border:1px solid #ffffff; color:#ffffff; width:30px; height:30px; border-radius:6px; display:flex; align-items:center; justify-content:center; font-size:18px; font-weight:bold;">⬇</button>
        </div>
      </div>
    </div>
  </div>
</ng-template>

<!-- Standard Search Modal -->
<div class="modal-overlay" *ngIf="showStandardSearchModal()" (click)="closeStandardSearchModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>규정 검색 및 연결</h3>
      <button class="close-btn" (click)="closeStandardSearchModal()">×</button>
    </div>
    
    <div class="modal-body">
      <div class="search-box">
        <input 
          #searchInput
          type="text" 
          [(ngModel)]="standardSearchQuery" 
          placeholder="규정 ID 또는 제목으로 검색... (Enter키로 검색)"
          class="search-input"
          (input)="standardSearchQuery.set($any($event.target).value)"
          (keydown)="onStandardSearchKeydown($event)"
          autofocus>
      </div>
      
      <div class="standards-list">
        <div 
          *ngFor="let std of filteredStandards; let i = index" 
          class="standard-item"
          [class.selected]="selectedStandardIndex === i"
          (click)="linkStandard(std)"
          (mouseenter)="selectedStandardIndex = i">
          <span class="standard-id">{{ std.id }}</span>
          <span class="standard-title">{{ std.title }}</span>
          <span class="standard-category">{{ std.category }}</span>
        </div>
        
        <div *ngIf="filteredStandards.length === 0" class="no-results">
          검색 결과가 없습니다.
        </div>
      </div>
    </div>
  </div>
</div>
