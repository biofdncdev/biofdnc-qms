<div class="role-admin">
  <h3>권한 관리</h3>
  <div class="toolbar">
    <button mat-flat-button color="primary" (click)="saveChanges()" [disabled]="!Object.keys(pending).length">저장</button>
  </div>
  <table mat-table [dataSource]="rows" class="mat-elevation-z1">
    <ng-container matColumnDef="name">
      <th mat-header-cell *matHeaderCellDef>이름</th>
      <td mat-cell *matCellDef="let r">{{ r.name }}</td>
    </ng-container>

    <ng-container matColumnDef="email">
      <th mat-header-cell *matHeaderCellDef>이메일</th>
      <td mat-cell *matCellDef="let r">{{ r.email }}</td>
    </ng-container>

    <ng-container matColumnDef="created_at">
      <th mat-header-cell *matHeaderCellDef>가입일시</th>
      <td mat-cell *matCellDef="let r">{{ r.created_at | date:'yyyy-MM-dd HH:mm' }}</td>
    </ng-container>

    <ng-container matColumnDef="updated_at">
      <th mat-header-cell *matHeaderCellDef>최종수정일시</th>
      <td mat-cell *matCellDef="let r">{{ r.updated_at ? (r.updated_at | date:'yyyy-MM-dd HH:mm') : '-' }}</td>
    </ng-container>

    <ng-container matColumnDef="last_sign_in_at">
      <th mat-header-cell *matHeaderCellDef>마지막 로그인</th>
      <td mat-cell *matCellDef="let r">{{ r.last_sign_in_at ? (r.last_sign_in_at | date:'yyyy-MM-dd HH:mm') : '-' }}</td>
    </ng-container>

    <ng-container matColumnDef="is_online">
      <th mat-header-cell *matHeaderCellDef>온라인</th>
      <td mat-cell *matCellDef="let r">{{ r.is_online ? 'Yes' : 'No' }}</td>
    </ng-container>

    <ng-container matColumnDef="role">
      <th mat-header-cell *matHeaderCellDef>권한</th>
      <td mat-cell *matCellDef="let r">
        <mat-select [value]="pending[r.id] || r.role" (selectionChange)="markRole(r, $event.value)">
          <mat-option *ngFor="let role of roles" [value]="role">{{ role }}</mat-option>
        </mat-select>
      </td>
    </ng-container>

    <ng-container matColumnDef="actions">
      <th mat-header-cell *matHeaderCellDef>관리</th>
      <td mat-cell *matCellDef="let r">
        <button mat-icon-button matTooltip="비밀번호 초기화" (click)="resetPassword(r)"><mat-icon>lock_reset</mat-icon></button>
        <button mat-icon-button color="warn" matTooltip="사용자 삭제" (click)="deleteUser(r)"><mat-icon>delete</mat-icon></button>
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
  </table>
</div>
